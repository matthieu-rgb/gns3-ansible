---
# ============================================
# PLAYBOOK : Configuration des switches pour STP
# ============================================
# Ce playbook configure :
# - VLAN 10 sur chaque switch
# - Ports trunk entre les 3 switches (triangle)
# - Ports access pour les PCs
# ============================================

- name: "Configurer les switches (STP)"
  hosts: localhost
  connection: local
  gather_facts: no

  vars_files:
    - ../vars/network.yml

  tasks:
    # ============================================
    # √âTAPE 1 : R√©cup√©rer les infos du projet
    # ============================================
    - name: "R√©cup√©rer les projets"
      uri:
        url: "{{ gns3_url }}/projects"
        method: GET
      register: projets

    - name: "Chercher notre projet"
      set_fact:
        project_id: "{{ (projets.json | selectattr('name', 'equalto', project_name) | first).project_id }}"

    - name: "R√©cup√©rer tous les nodes"
      uri:
        url: "{{ gns3_url }}/projects/{{ project_id }}/nodes"
        method: GET
      register: all_nodes

    # ============================================
    # √âTAPE 2 : R√©cup√©rer les ports console
    # ============================================
    - name: "Extraire les ports console des switches"
      set_fact:
        switch1_console: "{{ (all_nodes.json | selectattr('name', 'equalto', 'Switch1') | first).console }}"
        switch2_console: "{{ (all_nodes.json | selectattr('name', 'equalto', 'Switch2') | first).console }}"
        switch3_console: "{{ (all_nodes.json | selectattr('name', 'equalto', 'Switch3') | first).console }}"

    - name: "Afficher les ports console"
      debug:
        msg:
          - "Switch1 : telnet 192.168.138.198 {{ switch1_console }}"
          - "Switch2 : telnet 192.168.138.198 {{ switch2_console }}"
          - "Switch3 : telnet 192.168.138.198 {{ switch3_console }}"

    # ============================================
    # √âTAPE 3 : Configurer Switch1
    # ============================================
    # Trunk : Eth0/0 (vers Switch2), Eth0/2 (vers Switch3)
    # Access : Eth0/1 (PC1, VLAN 10)
    # ============================================
    - name: "Configurer Switch1"
      ansible.builtin.shell: |
        expect << 'EOF'
        set timeout 30
        spawn telnet 192.168.138.198 {{ switch1_console }}
        sleep 2
        send "\r"
        sleep 1
        expect "#"
        send "configure terminal\r"
        expect "#"

        # Cr√©er le VLAN 10
        send "vlan 10\r"
        expect "#"
        send "name Production\r"
        expect "#"
        send "exit\r"
        expect "#"

        # Port trunk vers Switch2 (Eth0/0)
        send "interface Ethernet0/0\r"
        expect "#"
        send "switchport trunk encapsulation dot1q\r"
        expect "#"
        send "switchport mode trunk\r"
        expect "#"
        send "no shutdown\r"
        expect "#"
        send "exit\r"
        expect "#"

        # Port trunk vers Switch3 (Eth0/2)
        send "interface Ethernet0/2\r"
        expect "#"
        send "switchport trunk encapsulation dot1q\r"
        expect "#"
        send "switchport mode trunk\r"
        expect "#"
        send "no shutdown\r"
        expect "#"
        send "exit\r"
        expect "#"

        # Port access pour PC1 (Eth0/1, VLAN 10)
        send "interface Ethernet0/1\r"
        expect "#"
        send "switchport mode access\r"
        expect "#"
        send "switchport access vlan 10\r"
        expect "#"
        send "no shutdown\r"
        expect "#"
        send "exit\r"
        expect "#"

        send "end\r"
        expect "#"
        send "write memory\r"
        sleep 2
        send "\r"
        expect "#"
        send "exit\r"
        EOF
      args:
        executable: /bin/bash

    # ============================================
    # √âTAPE 4 : Configurer Switch2
    # ============================================
    # Trunk : Eth0/0 (vers Switch1), Eth0/2 (vers Switch3)
    # Access : Eth0/1 (PC2, VLAN 10)
    # ============================================
    - name: "Configurer Switch2"
      ansible.builtin.shell: |
        expect << 'EOF'
        set timeout 30
        spawn telnet 192.168.138.198 {{ switch2_console }}
        sleep 2
        send "\r"
        sleep 1
        expect "#"
        send "configure terminal\r"
        expect "#"

        # Cr√©er le VLAN 10
        send "vlan 10\r"
        expect "#"
        send "name Production\r"
        expect "#"
        send "exit\r"
        expect "#"

        # Port trunk vers Switch1 (Eth0/0)
        send "interface Ethernet0/0\r"
        expect "#"
        send "switchport trunk encapsulation dot1q\r"
        expect "#"
        send "switchport mode trunk\r"
        expect "#"
        send "no shutdown\r"
        expect "#"
        send "exit\r"
        expect "#"

        # Port trunk vers Switch3 (Eth0/2)
        send "interface Ethernet0/2\r"
        expect "#"
        send "switchport trunk encapsulation dot1q\r"
        expect "#"
        send "switchport mode trunk\r"
        expect "#"
        send "no shutdown\r"
        expect "#"
        send "exit\r"
        expect "#"

        # Port access pour PC2 (Eth0/1, VLAN 10)
        send "interface Ethernet0/1\r"
        expect "#"
        send "switchport mode access\r"
        expect "#"
        send "switchport access vlan 10\r"
        expect "#"
        send "no shutdown\r"
        expect "#"
        send "exit\r"
        expect "#"

        send "end\r"
        expect "#"
        send "write memory\r"
        sleep 2
        send "\r"
        expect "#"
        send "exit\r"
        EOF
      args:
        executable: /bin/bash

    # ============================================
    # √âTAPE 5 : Configurer Switch3
    # ============================================
    # Trunk : Eth0/0 (vers Switch1), Eth0/2 (vers Switch2)
    # Access : Eth0/1 (PC3, VLAN 10)
    # ============================================
    - name: "Configurer Switch3"
      ansible.builtin.shell: |
        expect << 'EOF'
        set timeout 30
        spawn telnet 192.168.138.198 {{ switch3_console }}
        sleep 2
        send "\r"
        sleep 1
        expect "#"
        send "configure terminal\r"
        expect "#"

        # Cr√©er le VLAN 10
        send "vlan 10\r"
        expect "#"
        send "name Production\r"
        expect "#"
        send "exit\r"
        expect "#"

        # Port trunk vers Switch1 (Eth0/0)
        send "interface Ethernet0/0\r"
        expect "#"
        send "switchport trunk encapsulation dot1q\r"
        expect "#"
        send "switchport mode trunk\r"
        expect "#"
        send "no shutdown\r"
        expect "#"
        send "exit\r"
        expect "#"

        # Port trunk vers Switch2 (Eth0/2)
        send "interface Ethernet0/2\r"
        expect "#"
        send "switchport trunk encapsulation dot1q\r"
        expect "#"
        send "switchport mode trunk\r"
        expect "#"
        send "no shutdown\r"
        expect "#"
        send "exit\r"
        expect "#"

        # Port access pour PC3 (Eth0/1, VLAN 10)
        send "interface Ethernet0/1\r"
        expect "#"
        send "switchport mode access\r"
        expect "#"
        send "switchport access vlan 10\r"
        expect "#"
        send "no shutdown\r"
        expect "#"
        send "exit\r"
        expect "#"

        send "end\r"
        expect "#"
        send "write memory\r"
        sleep 2
        send "\r"
        expect "#"
        send "exit\r"
        EOF
      args:
        executable: /bin/bash

    # ============================================
    # R√âSUM√â
    # ============================================
    - name: "Configuration termin√©e"
      debug:
        msg: |
          ‚úÖ Les 3 switches sont configur√©s !

          üìä Configuration:
          - VLAN 10 (Production) cr√©√© sur chaque switch
          - Ports trunk entre les 3 switches (triangle)
          - Ports access pour les PCs (VLAN 10)

          üîú Prochaine √©tape: ansible-playbook playbooks/03_analyze_stp.yml

          üí° Ou manuellement:
             telnet 192.168.138.198 {{ switch1_console }}
             show spanning-tree vlan 10
