---
# ============================================
# PLAYBOOK : Analyse du Spanning Tree Protocol
# ============================================
# Ce playbook analyse :
# - Quel switch est le Root Bridge
# - Les ports Root, Designated et Blocked
# - L'√©tat STP sur chaque switch
# ============================================

- name: "Analyser le Spanning Tree Protocol"
  hosts: localhost
  connection: local
  gather_facts: no

  vars_files:
    - ../vars/network.yml

  tasks:
    # ============================================
    # √âTAPE 1 : R√©cup√©rer les infos du projet
    # ============================================
    - name: "R√©cup√©rer les projets"
      uri:
        url: "{{ gns3_url }}/projects"
        method: GET
      register: projets

    - name: "Chercher notre projet"
      set_fact:
        project_id: "{{ (projets.json | selectattr('name', 'equalto', project_name) | first).project_id }}"

    - name: "R√©cup√©rer tous les nodes"
      uri:
        url: "{{ gns3_url }}/projects/{{ project_id }}/nodes"
        method: GET
      register: all_nodes

    # ============================================
    # √âTAPE 2 : R√©cup√©rer les ports console
    # ============================================
    - name: "Extraire les ports console des switches"
      set_fact:
        switch1_console: "{{ (all_nodes.json | selectattr('name', 'equalto', 'Switch1') | first).console }}"
        switch2_console: "{{ (all_nodes.json | selectattr('name', 'equalto', 'Switch2') | first).console }}"
        switch3_console: "{{ (all_nodes.json | selectattr('name', 'equalto', 'Switch3') | first).console }}"

    # ============================================
    # √âTAPE 3 : Analyser STP sur Switch1
    # ============================================
    - name: "Analyser STP sur Switch1"
      ansible.builtin.shell: |
        expect << 'EOF'
        set timeout 30
        spawn telnet 192.168.138.198 {{ switch1_console }}
        sleep 2
        send "\r"
        sleep 1
        expect "#"
        send "show spanning-tree vlan 10\r"
        expect "#"
        send "exit\r"
        expect eof
        EOF
      args:
        executable: /bin/bash
      register: stp_switch1

    - name: "R√©sultat STP Switch1"
      debug:
        msg: "{{ stp_switch1.stdout_lines }}"

    # ============================================
    # √âTAPE 4 : Analyser STP sur Switch2
    # ============================================
    - name: "Analyser STP sur Switch2"
      ansible.builtin.shell: |
        expect << 'EOF'
        set timeout 30
        spawn telnet 192.168.138.198 {{ switch2_console }}
        sleep 2
        send "\r"
        sleep 1
        expect "#"
        send "show spanning-tree vlan 10\r"
        expect "#"
        send "exit\r"
        expect eof
        EOF
      args:
        executable: /bin/bash
      register: stp_switch2

    - name: "R√©sultat STP Switch2"
      debug:
        msg: "{{ stp_switch2.stdout_lines }}"

    # ============================================
    # √âTAPE 5 : Analyser STP sur Switch3
    # ============================================
    - name: "Analyser STP sur Switch3"
      ansible.builtin.shell: |
        expect << 'EOF'
        set timeout 30
        spawn telnet 192.168.138.198 {{ switch3_console }}
        sleep 2
        send "\r"
        sleep 1
        expect "#"
        send "show spanning-tree vlan 10\r"
        expect "#"
        send "exit\r"
        expect eof
        EOF
      args:
        executable: /bin/bash
      register: stp_switch3

    - name: "R√©sultat STP Switch3"
      debug:
        msg: "{{ stp_switch3.stdout_lines }}"

    # ============================================
    # R√âSUM√â
    # ============================================
    - name: "Guide d'interpr√©tation"
      debug:
        msg: |
          ============================================
          üìö GUIDE D'INTERPR√âTATION STP
          ============================================

          üîç Dans les r√©sultats, cherchez :

          1Ô∏è‚É£  ROOT BRIDGE (Pont Racine)
             ‚Üí "This bridge is the root"
             ‚Üí Le switch avec la PLUS BASSE priorit√©
             ‚Üí Priorit√© par d√©faut : 32768 + VLAN ID

          2Ô∏è‚É£  R√îLES DES PORTS
             ‚Üí Root (Root)     : Meilleur chemin vers le Root Bridge
             ‚Üí Desg (Designated) : Port qui forward le trafic
             ‚Üí BLK  (Blocked)  : Port bloqu√© pour √©viter la boucle
             ‚Üí Altn (Alternate) : Port de backup (bloqu√©)

          3Ô∏è‚É£  √âTATS DES PORTS
             ‚Üí FWD (Forwarding) : Actif, transmet le trafic
             ‚Üí BLK (Blocking)   : Bloqu√©, ne transmet pas
             ‚Üí LRN (Learning)   : Apprend les MAC, ne transmet pas encore
             ‚Üí LIS (Listening)  : √âcoute les BPDU

          ============================================
          üîß COMMANDES MANUELLES UTILES
          ============================================

          telnet 192.168.138.198 {{ switch1_console }}

          show spanning-tree vlan 10
          show spanning-tree summary
          show spanning-tree interface Eth0/0

          ============================================
