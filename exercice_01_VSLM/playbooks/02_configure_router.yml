---
- name: "Configurer le routeur"
  hosts: localhost
  connection: "local"
  gather_facts: no
  vars_files:
    - ../vars/vlsm_network.yml
  tasks:
    - name: "Récupérer les projets existants"
      uri:
        url: "{{ gns3_url }}/projects"
        method: GET
      register: projets
    - name: "Chercher notre projet"
      set_fact:
        projet_existant: "{{ projets.json | selectattr('name', 'equalto', project_name) | first }}"
    - name: "Extraire le project_id"
      set_fact:
        project_id: "{{ projet_existant.project_id }}"
    - name: "Recupérer tous les nodes"
      uri:
        url: "{{ gns3_url }}/projects/{{ project_id }}/nodes"
        method: GET
      register: all_nodes
    - name: "Extraire le routeur_id"
      set_fact:
        routeur_id: "{{ (all_nodes.json | selectattr('name', 'equalto', 'Routeur1') | first).node_id }}"
    - name: "Récupérer les infos du routeur"
      uri:
        url: "{{ gns3_url }}/projects/{{ project_id }}/nodes/{{ routeur_id }}"
        method: GET
      register: routeur_info
    - name: "Afficher le port console"
      debug:
        msg: "Console Telnet: 192.168.138.198:{{ routeur_info.json.console }}"
    - name: "Configurer le routeur complet"
      ansible.builtin.shell: |
        expect << 'EOF'
        set timeout 60
        spawn telnet 192.168.138.198 {{ routeur_info.json.console }}

        expect "Press RETURN" { send "\r" }
        expect "#"

        send "configure terminal\r"
        expect "#"

        send "interface FastEthernet0/0\r"
        expect "#"
        send "no shutdown\r"
        expect "#"
        send "ip address dhcp\r"
        expect "#"
        send "ip nat outside\r"
        expect "#"
        send "exit\r"
        expect "#"

        send "interface FastEthernet0/1\r"
        expect "#"
        send "no shutdown\r"
        expect "#"
        send "exit\r"
        expect "#"

        {% for vlan in vlans %}
        send "interface FastEthernet0/1.{{ vlan.id }}\r"
        expect "#"
        send "encapsulation dot1Q {{ vlan.id }}\r"
        expect "#"
        send "ip address {{ vlan.gateway }} {{ vlan.mask }}\r"
        expect "#"
        send "ip nat inside\r"
        expect "#"
        send "no shutdown\r"
        expect "#"
        send "exit\r"
        expect "#"
        {% endfor %}

        {% for vlan in vlans %}
        send "ip dhcp excluded-address {{ vlan.gateway }}\r"
        expect "#"
        send "ip dhcp pool POOL_{{ vlan.name }}\r"
        expect "#"
        send "network {{ vlan.network }} {{ vlan.mask }}\r"
        expect "#"
        send "default-router {{ vlan.gateway }}\r"
        expect "#"
        send "dns-server {{ dns.primary }} {{ dns.secondary }}\r"
        expect "#"
        send "exit\r"
        expect "#"
        {% endfor %}

        send "access-list 1 permit 192.168.100.0 0.0.0.255\r"
        expect "#"
        send "ip nat inside source list 1 interface FastEthernet0/0 overload\r"
        expect "#"
        send "exit\r"
        expect "#"
        send "write memory\r"
        expect "#"
        send "exit\r"
        expect eof
        EOF
      args:
        executable: /bin/bash
