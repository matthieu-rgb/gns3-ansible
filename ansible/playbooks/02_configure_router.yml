---
- name: "Configurer le routeur"
  hosts: localhost
  connection: "local"
  gather_facts: no

  vars_files:
    - ../vars/vlsm_network.yml

  tasks:
    - name: "Récupérer les projets existants"
      uri:
        url: "{{ gns3_url }}/projects"
        method: GET
      register: projets

    - name: "Afficher les projets"
      debug:
        msg: "Projets trouvés : {{ projets.json | map(attribute='name') | list }}"

    - name: "Chercher notre projet"
      set_fact:
        projet_existant: "{{ projets.json | selectattr('name', 'equalto', project_name) | list | first | default(none) }}"

    - name: "Extraire le project_id"
      set_fact:
        project_id: "{{ projet_existant.project_id }}"

    - name: "Afficher le project_id"
      debug:
        msg: "Project ID: {{ project_id }}"

    - name: "Recupérer tous les nodes"
      uri:
        url: "{{ gns3_url }}/projects/{{ project_id }}/nodes"
        method: GET
      register: all_nodes

    - name: "Extraire le routeur_id"
      set_fact:
        routeur_id: "{{ (all_nodes.json | selectattr('name', 'equalto', 'Routeur1') | first).node_id }}"

    - name: "Récupérer les infos du routeur"
      uri:
        url: "{{ gns3_url }}/projects/{{ project_id }}/nodes/{{ routeur_id }}"
        method: GET
      register: routeur_info

    - name: "Afficher le port console"
      debug:
        msg: "Console Telnet: localhost:{{ routeur_info.json.console }}"

    - name: "Configurer l'interface WAN"
      ansible.netcommon.telnet:
        host: localhost
        port: "{{ routeur_info.json.console }}"
        login_prompt: false
        prompts:
          - ">"
          - "#"
        command:
          - "enable"
          - "configure terminal"
          - "interface FastEthernet0/0"
          - "no shutdown"
          - "ip address dhcp"
          - "exit"

    - name: "Configurer route et DNS"
      ansible.netcommon.telnet:
        host: localhost
        port: "{{ routeur_info.json.console }}"
        login_prompt: false
        prompts:
          - "#"
        command:
          - "configure terminal"
          - "ip route 0.0.0.0 0.0.0.0 dhcp"
          - "ip name-server {{ dns.primary }}"
          - "ip name-server {{ dns.secondary }}"
          - "ip domain-lookup"
          - "exit"

    - name: "Créer les sous-interfaces VLAN"
      ansible.netcommon.telnet:
        host: localhost
        port: "{{ routeur_info.json.console }}"
        login_prompt: false
        prompts:
          - "#"
        command:
          - "configure terminal"
          - "interface FastEthernet0/1.{{ item.id }}"
          - "encapsulation dot1Q {{ item.id }}"
          - "ip address {{ item.gateway }} {{ item.mask }}"
          - "no shutdown"
          - "exit"
      loop: "{{ vlans }}"

    - name: "Pool DHCP"
      ansible.netcommon.telnet:
        host: localhost
        port: "{{ routeur_info.json.console }}"
        login_prompt: false
        prompts:
          - "#"
        command:
          - "configure terminal"
          - "ip dhcp excluded-address {{ item.gateway }}"
          - "ip dhcp pool POOL_{{ item.name }}"
          - "network {{ item.network }} {{ item.mask }}"
          - "default-router {{ item.gateway }}"
          - "dns-server {{ dns.primary }} {{ dns.secondary }}"
          - "exit"
      loop: "{{ vlans }}"

    - name: "NAT"
      ansible.netcommon.telnet:
        host: localhost
        port: "{{ routeur_info.json.console }}"
        login_prompt: false
        prompts:
          - "#"
        command:
          - "configure terminal"
          - "interface FastEthernet0/0"
          - "ip nat outside"
          - "exit"
          - "interface FastEthernet0/1"
          - "ip nat inside"
          - "exit"
          - "access-list 1 permit 192.168.100.0 0.0.0.255"
          - "ip nat inside source list 1 interface FastEthernet0/0 overload"
          - "exit"

    - name: "Sauvegarder la configuration"
      ansible.netcommon.telnet:
        host: localhost
        port: "{{ routeur_info.json.console }}"
        login_prompt: false
        prompts:
          - "#"
        command:
          - "end"
          - "write memory"
