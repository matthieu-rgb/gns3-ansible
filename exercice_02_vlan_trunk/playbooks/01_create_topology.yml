- name: "Créer la topologie VLAN Trunk"
  hosts: localhost
  connection: local
  gather_facts: no

  vars_files:
    - ../vars/network.yml

  tasks:
    # ============================================
    # ÉTAPE 1 : Connexion et création du projet
    # ============================================
    - name: "Vérifier la connexion GNS3"
      uri:
        url: "{{ gns3_url }}/version"
        method: GET
      register: gns3_version

    - name: "Afficher la version GNS3"
      debug:
        msg: "GNS3 version: {{ gns3_version.json.version }}"

    - name: "Créer le projet GNS3"
      uri:
        url: "{{ gns3_url }}/projects"
        method: POST
        body_format: json
        body:
          name: "{{ project_name }}"
        status_code: [200, 201, 409]
      register: project_creation

    - name: "Récupérer les projets existants"
      uri:
        url: "{{ gns3_url }}/projects"
        method: GET
      register: projets

    - name: "Chercher notre projet"
      set_fact:
        projet_existant: "{{ projets.json | selectattr('name', 'equalto', project_name) | first }}"

    - name: "Extraire le project_id"
      set_fact:
        project_id: "{{ projet_existant.project_id }}"

    - name: "Afficher le project_id"
      debug:
        msg: "Project ID: {{ project_id }}"

    - name: "Ouvrir le projet"
      uri:
        url: "{{ gns3_url }}/projects/{{ project_id }}/open"
        method: POST
        status_code: [200, 201, 204]

      # ============================================
      # ÉTAPE 2 : Récupérer les templates
      # ============================================
    - name: "Lister les templates disponibles"
      uri:
        url: "{{ gns3_url }}/templates"
        method: GET
      register: templates

    - name: "Afficher les templates"
      debug:
        msg: "{{ templates.json | map(attribute='name') | list }}"

    - name: "Extraire le template_id du switch IOU L2"
      set_fact:
        switch_template_id: "{{ (templates.json | selectattr('name', 'equalto', 'Cisco IOU L2') | first).template_id }}"

    - name: "Afficher le template_id du switch"
      debug:
        msg: "Template Switch IOU L2: {{ switch_template_id }}"

    # ============================================
    # ÉTAPE 3 : Créer les switches
    # ============================================
    - name: "Créer les switches"
      uri:
        url: "{{ gns3_url }}/projects/{{ project_id }}/templates/{{ switch_template_id }}"
        method: POST
        body_format: json
        body:
          name: "{{ item.name }}"
          x: "{{ item.x }}"
          y: "{{ item.y }}"
        status_code: [200, 201]
      loop: "{{ switches }}"

    # ============================================
    # ÉTAPE 4 : Créer les PCs
    # ============================================
    - name: "Créer les PCs"
      uri:
        url: "{{ gns3_url }}/projects/{{ project_id }}/nodes"
        method: POST
        body_format: json
        body:
          name: "{{ item.name }}"
          node_type: "vpcs"
          compute_id: "local"
          x: "{{ item.x }}"
          y: "{{ item.y }}"
        status_code: [200, 201]
      loop: "{{ pcs }}"

    # ============================================
    # ÉTAPE 5 : Récupérer tous les nodes créés
    # ============================================
    - name: "Récupérer tous les nodes"
      uri:
        url: "{{ gns3_url }}/projects/{{ project_id }}/nodes"
        method: GET
      register: all_nodes

    - name: "Afficher tous les nodes"
      debug:
        msg: "{{ all_nodes.json | map(attribute='name') | list }}"

    # ============================================
    # ÉTAPE 6 : Créer les liens trunk entre switches
    # ============================================
    - name: "Créer les liens trunk"
      uri:
        url: "{{ gns3_url }}/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        body:
          nodes:
            - node_id: "{{ (all_nodes.json | selectattr('name', 'equalto', item.switch_a) | first).node_id }}"
              adapter_number: "{{ item.adapter_a }}"
              port_number: "{{ item.port_a }}"
            - node_id: "{{ (all_nodes.json | selectattr('name', 'equalto', item.switch_b) | first).node_id }}"
              adapter_number: "{{ item.adapter_b }}"
              port_number: "{{ item.port_b }}"
        status_code: [200, 201]
      loop: "{{ trunks }}"

    # ============================================
    # ÉTAPE 7 : Créer les liens switch <-> PC
    # ============================================
    - name: "Créer les liens PC <-> Switch"
      uri:
        url: "{{ gns3_url }}/projects/{{ project_id }}/links"
        method: POST
        body_format: json
        body:
          nodes:
            - node_id: "{{ (all_nodes.json | selectattr('name', 'equalto', item.switch) | first).node_id }}"
              adapter_number: "{{ item.adapter }}"
              port_number: "{{ item.port }}"
            - node_id: "{{ (all_nodes.json | selectattr('name', 'equalto', item.name) | first).node_id }}"
              adapter_number: 0
              port_number: 0
        status_code: [200, 201]
      loop: "{{ pcs }}"

    # ============================================
    # ÉTAPE 8 : Démarrer tous les nodes
    # ============================================
    - name: "Démarrer tous les nodes"
      uri:
        url: "{{ gns3_url }}/projects/{{ project_id }}/nodes/start"
        method: POST
        status_code: [200, 201, 204]

    - name: "Topologie créée avec succès"
      debug:
        msg: "✅ Topologie créée ! 3 switches, 6 PCs, liens trunk configurés."
